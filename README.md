# libuv UV_THREADPOOL_SIZE test

![image](https://github.com/skrevolve/libuv-thread-pool-size/assets/41939976/08647e01-0b8f-482f-844f-ed9ff2f4e324)</br>

Nodejs libuvì˜ ìŠ¤ë ˆë“œ í’€ í¬ê¸°ë¡œ ì¸í•´ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë³‘ëª© í˜„ìƒì´ ë°œìƒí•˜ëŠ” ë°©ë²•ê³¼ ì´ë¥¼ ìˆ˜ì •í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.</br>
**libuvì— ì¡´ì¬í•˜ëŠ” I/Oê°€ ë§ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê²½ìš° libuv ìŠ¤ë ˆë“œ í’€ í¬ê¸°ëŠ” ì‹¬ê°í•œ ë³‘ëª© í˜„ìƒì´ ë  ìˆ˜ ìˆìœ¼ë©° ì´ ì²˜ë¦¬ëŸ‰ì„ ëŠ˜ë¦¬ëŠ”ë° ê°€ì¥ í° ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ìš”ì¸ì¤‘ í•˜ë‚˜ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

## What is libuv?

![image](https://github.com/skrevolve/libuv-thread-pool-size/assets/41939976/9e54dc13-c90e-407d-a7de-6f913405c339)</br>
libuvëŠ” ë¹„ë™ê¸° I/Oë¥¼ ìœ„í•œ ë‹¤ì¤‘ í”Œë«í¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤

- [libuv github](https://github.com/libuv/libuv)
- [libuv docs](https://docs.libuv.org/en/v1.x/threadpool.html)

## Must Knows

- Node.jsì˜ I/O ë°©ë²• ì¤‘ ì¼ë¶€ëŠ” libuvì— ì˜ì¡´í•©ë‹ˆë‹¤.</br>
  ê°€ëŠ¥í•œ ê²½ìš° Node.jsëŠ” ì´ë¯¸ ë¹„ë™ê¸°/ë¹„ì°¨ë‹¨ APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</br>
  ë‹¤ë¥¸ ê²½ìš° libuvëŠ” ìŠ¤ë ˆë“œ í’€ì„ ì‚¬ìš©í•˜ì—¬ ë™ê¸°í™”/ì°¨ë‹¨ I/Oë¥¼ ë¹„ë™ê¸°/ë¹„ì°¨ë‹¨ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤</br>
- libuvì˜ ìŠ¤ë ˆë“œ í’€ í¬ê¸°ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ 4 ì…ë‹ˆë‹¤

## Whatâ€™s the Problem?

libuvì˜ ê¸°ë³¸ ìŠ¤ë ˆë“œ í’€ í¬ê¸°ëŠ” 4ì…ë‹ˆë‹¤.</br>
libvì— ì˜ì¡´í•˜ëŠ” 4ê°œ ì´ìƒì˜ ë™ì‹œ I/Oì‘ì—…ì„ ìˆ˜í–‰í•˜ë©´ ê°ê°ì˜ ì¶”ê°€ ì‘ì—…ì´ ëŒ€ê¸°ì—´ì—ì„œ ëŒ€ê¸°í•´ì•¼ í•˜ë¯€ë¡œ libuvì˜ ì‘ì€ ìŠ¤ë ˆë“œ í’€ í¬ê¸°ê°€ ë³‘ëª© í˜„ìƒì„ ë°œìƒì‹œí‚µë‹ˆë‹¤.</br>

![image](https://github.com/skrevolve/libuv-thread-pool-size/assets/41939976/10dc5dd4-cde3-47af-b764-43375bc93f5d)</br>

ë‹¤ìŒì€ libuvì˜ thread poolì„ ì‚¬ìš©í•˜ëŠ” ì¼ë¶€ I/O ì‘ì—…ì…ë‹ˆë‹¤.

- file system : fs.FSWatcher(), syncrhonus fsë¥¼ ì œì™¸í•œ ëª¨ë“  íŒŒì¼ ì‹œìŠ¤í…œ ì‘ì—…
- DNS : dns.lookup(), dns.lookupService()
- Crypto : crypto.pbkdf2(), crypto.scrypt(), crypto.randomBytes(), crypto.randomFill()..
- Zlib : synchronous API ì œì™¸
- ub_queue_workë¥¼ í˜¸ì¶œí•˜ëŠ” Lib ë° ì‚¬ìš©ì ì½”ë“œ

## Solving It

Node.js ë¥¼ ì‹œì‘í•˜ê¸° ì „ì— I/Oí˜¸ì¶œì„ ìˆ˜í–‰í•˜ê¸° ì „ì— UV_THREADPOOL_SIZE ë³€ìˆ˜ í¬ê¸°ë¥¼ ëŠ˜ë ¤ ë³€ê²½ í•´ì•¼ í•©ë‹ˆë‹¤.</br>
libuvëŠ” ìŠ¤ë ˆë“œ í’€ì— ì˜ì¡´í•˜ëŠ” I/O ë©”ì„œë“œë¥¼ ì²˜ìŒ í˜¸ì¶œí•  ë•Œ ìŠ¤ë ˆë“œ í’€ì„ ì¸ìŠ¤í„´ìŠ¤í™” í•©ë‹ˆë‹¤.</br>
ì¼ë‹¨ ì¸ìŠ¤í„´ìŠ¤í™”ë˜ë©´ ìŠ¤ë ˆë“œ í’€ í¬ê¸°(UV_THREADPOOL_SIZE)ì— ëŒ€í•œ ë³€ê²½ ì‚¬í•­ì€ ì ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</br>

## Examples

Node.jsë¥¼ ì‹œì‘í•˜ê¸° ì „ì— UV_THREADPOOL_SIZEë¥¼ ë³€ê²½í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</br>
Node.jsë¥¼ ì‹œì‘í•˜ê¸° ì „ì— í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ë©´ ì˜ë„ê°€ ë” ëª…í™•í•´ì§€ê³  ë¬´ì–¸ê°€ ì˜ëª»ëœ ê°€ëŠ¥ì„±ì´ ì¤„ì–´ë“­ë‹ˆë‹¤.(í¬í•¨ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¶€ì‘ìš©ìœ¼ë¡œ I/Oë¥¼ í˜¸ì¶œí•¨)</br>

### Via Bash

```sh
UV_THREADPOOL_SIZE=64 node ./out/main.js
```

### Via Windows CLI

```sh
SET UV_THREADPOOL_SIZE=64 && node ./out/main.js
```

### As first instruction in Node.js app: (not recommended)

```js
'use strict'
process.env.UV_THREADPOOL_SIZE=64
```

## How High Should I Set It?

ì„¤ì •í•˜ëŠ” ê°’ì€ ê²½ìš°ì— ë”°ë¼ ë‹¤ë¦…ë‹ˆë‹¤.</br>
cpu ì½”ì–´ ìˆ˜ë¡œ ì˜ˆì‹œë¡œí•œ ìë£Œë“¤ì´ ë§ì€ë° libuvì¸¡ ì´ìŠˆì—ì„œ ìƒê´€ì´ ìˆëŠ”ì§€ì— ëŒ€í•œ ë…¼ìŸì´ ìˆì—ˆìŠµë‹ˆë‹¤.</br>
-> [Change default thread pool size from fixed 4 to number of logical cores #1578](https://github.com/joyent/libuv/issues/1578)</br>
CPU intensiveí•œ ì‘ì—…ì€ thread poolì—ì„œ ì²˜ë¦¬ë˜ë¯€ë¡œ thread ìˆ˜ë¥¼ ëŠ˜ë¦¬ë©´ ê·¸ë§Œí¼ context switching ì´ ëŠ˜ì–´ë‚˜ ë³´í†µ ë¬¼ë¦¬ì½”ì–´ ìˆ˜ë§Œí¼ size ì„¤ì •í•˜ê¸°ë¥¼ ê¶Œì¥í•œë‹¤ê³  í•©ë‹ˆë‹¤.</br>
ì´ì— ëŒ€í•œ ë…¼ìŸì€ ì•„ë˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ í†µí•´ ì•Œì•„ ë³´ë©´ ë˜ê² ìŠµë‹ˆë‹¤.

- ìŠ¤ë ˆë“œ í’€ í¬ê¸°ëŠ” ìµœëŒ€ ë™ì‹œ I/O ì‘ì—…ì˜ ì •í™•í•œ ì–‘ì…ë‹ˆë‹¤
- ë„ˆë¬´ ë†’ê²Œ ì„¤ì •í•˜ë©´ ë„ˆë¬´ ë‚®ê²Œ ì„¤ì •í•˜ëŠ” ê²ƒë³´ë‹¤ ì²˜ë¦¬ëŸ‰ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì´ ì ìŠµë‹ˆë‹¤
- ê·¹ë‹¨ì ìœ¼ë¡œ ë†’ê²Œ ì„¤ì •í•  í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤
- ë©”ëª¨ë¦¬ ì˜¤ë²„í—¤ë“œëŠ” 128ê°œ ìŠ¤ë ˆë“œì— ëŒ€í•´ ~1MB ì…ë‹ˆë‹¤
- ìµœëŒ€ê°’(1.30.0 ì´í›„)ì€ 1024 ì…ë‹ˆë‹¤
- CPU ì½”ì–´ ìˆ˜ë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì€ ì¢‹ì€ ê¸°ì¤€ì´ ì•„ë‹™ë‹ˆë‹¤. ì´ëŠ” CPU ì§‘ì•½ì ì¸ ì‘ì—…ì´ ì•„ë‹Œ I/O ì‘ì—…ì…ë‹ˆë‹¤

### You can count threads in Linux

```sh
ps -Lef | grep "\<node\>" | wc -l
```

## Run Server

You can change **UV_THREADPOOL_SIZE** option in **package.json**

### Install & Build

```sh
npm install
npm run build
```

### Node

```sh
npm run start:dev
```

### PM2 fork mode

```sh
npm run start:fork
```

### PM2 cluster mode

```sh
npm run start:cluster
```

## Running test in CLI

```sh
chmod +x curl.sh #if you need change chown
./curl.sh -c 1 #run test case 1
./curl.sh -c 2 #run test case 1
./curl.sh -c 3 #run test case 1
```

## ğŸ’¥Running test

### case 1 (pm2 fork mode)

- parallels : 1
- curl request : 15

| **UV_THREADPOOL_SIZE** | **parallels** | **curl request** | **I/O operations** | **min(sec)** | **max(sec)** | **average(sec)** |
|------------------------|---------------|------------------|--------------------|--------------|--------------|------------------|
| 4                      | 1             | 15               | 10                 | **0.446**    | 18.723       | 9.620            |
| 8                      | 1             | 15               | 10                 | 0.591        | 11.809       | 6.130            |
| 12 (my cpu length)     | 1             | 15               | 10                 | 0.844        | 10.408       | **5.536**        |
| 16                     | 1             | 15               | 10                 | 0.902        | 10.526       | 5.770            |
| 32                     | 1             | 15               | 10                 | 1.413        | 10.249       | 6.160            |
| 64                     | 1             | 15               | 10                 | 3.569        | 9.970        | 7.033            |
| 128                    | 1             | 15               | 10                 | 6.394        | **9.602**    | 8.693            |
| 256                    | 1             | 15               | 10                 | 7.048        | 10.731       | 9.846            |
| 512                    | 1             | 15               | 10                 | 6.755        | 10.396       | 9.561            |
| 1024                   | 1             | 15               | 10                 | 7.233        | 10.691       | 9.732            |

### case 2 (pm2 fork mode)

- parallels : 15
- curl request : 1

| **UV_THREADPOOL_SIZE** | **parallels** | **curl request** | **I/O operations** | **min(sec)** | **max(sec)** | **average(sec)** |
|------------------------|---------------|------------------|--------------------|--------------|--------------|------------------|
| 4                      | 15            | 1                | 10                 | **0.513**    | 18.930       | 9.722            |
| 8                      | 15            | 1                | 10                 | 0.655        | 11.780       | 6.150            |
| 12 (my cpu length)     | 15            | 1                | 10                 | 0.837        | 11.037       | **5.850**        |
| 16                     | 15            | 1                | 10                 | 0.956        | 11.171       | 6.077            |
| 32                     | 15            | 1                | 10                 | 2.106        | 10.768       | 6.495            |
| 64                     | 15            | 1                | 10                 | 3.953        | 10.805       | 7.509            |
| 128                    | 15            | 1                | 10                 | 6.287        | **10.451**   | 9.230            |
| 256                    | 15            | 1                | 10                 | 5.707        | 10.945       | 10.004           |
| 512                    | 15            | 1                | 10                 | 5.106        | 10.697       | 10.091           |
| 1024                   | 15            | 1                | 10                 | 4.726        | 10.976       | 9.933            |

### case 3 (pm2 fork mode)

- parallels : 15
- curl request : 5

| **UV_THREADPOOL_SIZE** | **parallels** | **curl request** | **I/O operations** | **min(sec)** | **max(sec)**  | **average(sec)** |
|------------------------|---------------|------------------|--------------------|--------------|---------------|------------------|
| 4                      | 15            | 5                | 10                 | **0.563**    | 95.393        | 47.842           |
| 8                      | 15            | 5                | 10                 | 0.661        | 57.982        | 29.125           |
| 12 (my cpu length)     | 15            | 5                | 10                 | 0.903        | 54.387        | **27.639**       |
| 16                     | 15            | 5                | 10                 | 0.932        | 54.397        | 27.845           |
| 32                     | 15            | 5                | 10                 | 1.605        | 53.590        | 27.916           |
| 64                     | 15            | 5                | 10                 | 3.250        | 53.544        | 29.213           |
| 128                    | 15            | 5                | 10                 | 8.490        | 51.981        | 30.532           |
| 256                    | 15            | 5                | 10                 | 9.516        | **51.348**    | 33.927           |
| 512                    | 15            | 5                | 10                 | 24.724       | 49.495        | 39.482           |
| 1024                   | 15            | 5                | 10                 | 12.087       | 53.127        | 48.663           |

### case 1 (pm2 cluster mode :2 instances)

- parallels : 1
- curl request : 15

| **UV_THREADPOOL_SIZE** | **parallels** | **curl request** | **I/O operations** | **min(sec)** | **max(sec)** | **average(sec)** |
|------------------------|---------------|------------------|--------------------|--------------|--------------|------------------|
| 4                      | 15            | 5                | 10                 | 0.566        | 12.160       | 6.179            |
| 8                      | 15            | 5                | 10                 | 0.889        | 10.332       | 5.611            |
| 12 (my cpu length)     | 15            | 5                | 10                 | 1.209        | 10.285       | 5.839            |
| 16                     | 15            | 5                | 10                 | 1.680        | 10.440       | 6.290            |
| 32                     | 15            | 5                | 10                 | 3.599        | 9.646        | 6.839            |
| 64                     | 15            | 5                | 10                 | 5.583        | 9.463        | 8.539            |
| 128                    | 15            | 5                | 10                 | 8.088        | 10.248       | 9.692            |
| 256                    | 15            | 5                | 10                 | 7.358        | 10.064       | 9.508            |
| 512                    | 15            | 5                | 10                 | 8.137        | 10.971       | 10.109           |
| 1024                   | 15            | 5                | 10                 | 7.433        | 10.660       | 9.789            |

### case 2 (pm2 cluster mode :2 instances)

- parallels : 15
- curl request : 1

| **UV_THREADPOOL_SIZE** | **parallels** | **curl request** | **I/O operations** | **min(sec)** | **max(sec)** | **average(sec)** |
|------------------------|---------------|------------------|--------------------|--------------|--------------|------------------|
| 4                      | 15            | 1                | 10                 | 0.642        | 12.685       | 6.411            |
| 8                      | 15            | 1                | 10                 | 0.978        | 11.726       | 6.064            |
| 12 (my cpu length)     | 15            | 1                | 10                 | 1.299        | 10.892       | 6.320            |
| 16                     | 15            | 1                | 10                 | 1.908        | 11.186       | 6.615            |
| 32                     | 15            | 1                | 10                 | 4.206        | 10.486       | 7.313            |
| 64                     | 15            | 1                | 10                 | 7.378        | 10.840       | 9.119            |
| 128                    | 15            | 1                | 10                 | 6.445        | 10.621       | 9.995            |
| 256                    | 15            | 1                | 10                 | 7.303        | 10.917       | 10.133           |
| 512                    | 15            | 1                | 10                 | 7.157        | 11.214       | 10.788           |
| 1024                   | 15            | 1                | 10                 | 9.703        | 11.351       | 10.843           |

### case 3 (pm2 cluster mode :2 instances)

- parallels : 15
- curl request : 5

| **UV_THREADPOOL_SIZE** | **parallels** | **curl request** | **I/O operations** | **min(sec)** | **max(sec)** | **average(sec)** |
|------------------------|---------------|------------------|--------------------|--------------|--------------|------------------|
| 4                      | 15            | 5                | 10                 | 0.665        | 62.578       | 29.898           |
| 8                      | 15            | 5                | 10                 | 0.965        | 53.793       | 27.016           |
| 12 (my cpu length)     | 15            | 5                | 10                 | 0.989        | 53.703       | 27.705           |
| 16                     | 15            | 5                | 10                 | 1.206        | 53.640       | 27.870           |
| 32                     | 15            | 5                | 10                 | 4.024        | 53.233       | 28.851           |
| 64                     | 15            | 5                | 10                 | 6.078        | 52.651       | 30.346           |
| 128                    | 15            | 5                | 10                 | 11.333       | 53.116       | 35.057           |
| 256                    | 15            | 5                | 10                 | 32.019       | 50.880       | 40.265           |
| 512                    | 15            | 5                | 10                 | 32.246       | 54.943       | 51.456           |
| 1024                   | 15            | 5                | 10                 | 34.931       | 53.018       | 49.394           |

</br>

## ì°¸ê³ ìë£Œ

- [libuv ì„¤ê³„ ê°œìš”](https://docs.libuv.org/en/latest/design.html)
- [libuv API: ìŠ¤ë ˆë“œ í’€ ì‘ì—… ìŠ¤ì¼€ì¤„ë§](https://docs.libuv.org/en/v1.x/threadpool.html)
- [Node.jsì˜ ìŠ¤ë ˆë“œ ë¬¸ì œ](https://kariera.future-processing.pl/blog/on-problems-with-threads-in-node-js/)
- [StackOverflow: "UV_THREADPOOL_SIZE í™˜ê²½ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•´ ë³¸ ì‚¬ëŒì´ ìˆìŠµë‹ˆê¹Œ?"](https://stackoverflow.com/questions/17554688/has-anyone-tried-using-the-uv-threadpool-size-environment-variable)
- [Change default thread pool size from fixed 4 to number of logical cores](https://github.com/joyent/libuv/issues/1578)
